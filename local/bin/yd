#!/bin/sh

# youtube-dl wrapper that downloads the binary if it doesn't exist
# and adds some options depending if the last link arg is a video or playlist

video_opts='--restrict-filenames --no-playlist -o "%(title)s.%(ext)s"'
playlist_opts='--restrict-filenames -o "%(playlist)s/%(playlist_index)s-%(title)s.%(ext)s"'
bin_dir="$HOME/.local/bin"

PATH="$bin_dir:$PATH"
original_args="$*"

if [ ! -x "$(command -v youtube-dl)" ]; then
	echo "youtube-dl command not found; downloading to $bin_dir"
	mkdir -p "$bin_dir"
	curl -L https://yt-dl.org/downloads/latest/youtube-dl -o "$bin_dir/youtube-dl"
	chmod a+rx "$bin_dir/youtube-dl"
fi

while [ $# -gt 0 ]; do
	case "$1" in
		https://*/playlist*)
			extra_opts="$playlist_opts"
			;;
		https://*)
			extra_opts="$video_opts"
			;;
	esac
	shift
done

cmd="youtube-dl $extra_opts $(printf "%s" "$original_args" | sed 's/&/\\&/g')"
echo "$cmd"
eval "$cmd"
