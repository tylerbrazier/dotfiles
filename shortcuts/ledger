#!/bin/bash

# Add an entry to ledger.csv that has 4 columns:
# Date,Amount,Description,Tags
# Tags can be used to categorize entries and identify rows;
# multiple tags for the same entry are separated by spaces.
# Later you can make some fancy awk scripts for the csv to build reports.

csv="$HOME/storage/shared/backup/docs/ledger.csv"
date=
amount="-"
description=
tags=

[ -f "$csv" ] || { echo "No $csv" >&2; exit 1; }

while [[ ! "$date" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; do
	read -rp "Date: " -i "$(date +%Y-%m-%d)" date
done

while [[ ! "$amount" =~ ^[+-]?[0-9]+(\.[0-9]+)?$ ]]; do
	read -rp "Amount: $" -i "$amount" amount
done

while [[ ! "$description" =~ ^[^,]+$ ]]; do
	read -rp "Description (no commas): " -i "$description" description
done

existing_tags="$(awk -F, 'NR>1{print $4}' "$csv" \
	| tr ' ' '\n' \
	| sort --ignore-case \
	| uniq --ignore-case \
	| paste -sd' ')"
while [[ ! "$tags" =~ ^[a-zA-Z0-9\ ]+$ ]]; do
	read -rp "Tags ($existing_tags): " -i "$tags" tags
done

echo "$date,$amount,$description,$tags" >> "$csv"

column -ts, "$csv" | sort -n | less -S +G
